<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de maquinas</title>
    <link rel="stylesheet" type="text/css" href="style/style.css"> 
    <script src="js/jquery-3.7.1.min.js" type="text/javascript"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script>
        // variavel global de controle para saber qual máquina está recebendo detalhamento
        var detailing = null;
        let server_address;

        fetch('configs/ip_addrs')
            .then((res) => res.text())
            .then((text) => {
                server_address = text;
            })
            .catch((e) => console.error(e));

        $(document).ready(function(){
            // variavel de controle para ver quantas máquinas possuem cards
            var cards = [];

            // variavel de controle para ver quantas máquinas estão trackeadas
            var totalMachines = 0;


            function getData() {
            $.ajax({
                url: `http://${server_address}:5000/api/devices`,
                type: "GET",
                success: function(data) {

                    
                    const modal = document.getElementById('modalMain')

                    if (modal.style.display == 'block') {
                        updateDetailing(
                            data[0][1][detailing][2],
                            data[0][1][detailing][3]
                        )
                    } else {
                        const dataGrid = document.getElementById('devices-container');
    
                        //variavel de controle para saber quantas máquinas estão conectadas
                        var machines = 0;
    
                        // verifica quais máquinas ativas existem
                        data[0][0].forEach(machine => {
                            if (machine != '' && machine[3] == "A"){
                                machines++;
    
                                // caso a quantidade de máquinas ativas seja diferente das trackeadas, define as rastreada como 
                                // a quantidade de ativas, forçando a gerar uma nova leva de cards com todas as máquinas
                                if (totalMachines != machines) {
                                    totalMachines = machines;
                                }
                            };
                        });
                        
                        console.log(machines)

                        if (machines == 0){ //verifica se não há nenhuma máquina rastreada
                            dataGrid.replaceChildren(); 
                        } else if ( // verifica se o elemento principal está vazio
                            dataGrid.innerHTML === "" || 
                            totalMachines != cards.length
                        ) {
                            // retira todos os cards presentes
                            dataGrid.replaceChildren();
                            // reinicia a variavel
                            cards = [];
                            // variável de controle para iteração
                            var i = 0;
    
    
                            data[0][0].forEach(cadastro => {
                                // verifica se é uma máquina válida (não vazia)
                                if (cadastro != '') {
                                    if (cadastro[3] == "A" && data[0][1][i][2] != 0) {
                                        const card = geraCard(data[0][1][i][0],
                                        cadastro[2],
                                        data[0][1][i][1],
                                        data[0][1][i][2],
                                        data[0][1][i][3]);
                                        cards.push(card);
                                    };
                                    i++;
                                }
                            });
    
                                cards.forEach(card => {
                                    dataGrid.appendChild(card);
                                })
                            
                            detailing = null;

                            } /* fim de caso esteja vazio;*/ else {
                                var i = 0;
                                data[0][0].forEach(machine => {
                                    if (machine != '') {
                                        if (machine[3] == 'A') {
                                            updateBar(data[0][1][i][1],'cpu'+machine[0])
                                            updateBar(data[0][1][i][3],'mem'+machine[0])
                                        };
                                    i++;
                                    };
                                });
                            }; // fim do outro caso (o que atualiza)
                    }

                } // fim da função que trabalha com os dados

            }); // fim função ajax

        }; // fim da getData()
            
        // chama a getData() para uma primeira iteração
        getData() 

        // chama a getData() a cada 'x' milissegundos
        setInterval(getData,1000)

    }); // fim função document.ready

    function geraCard(id,alias,cpuT,cpuD,mem){

        var actualID = id;

        // gerando o card (externo)
        const card = document.createElement('div');
        card.classList.add('machine-card');
        card.id = 'card' + id;

        const link = document.createElement('a')
        link.id = 'link' + id
        link.onclick = () => {geraDetailing(
            id,
            alias,
            cpuD,
            mem
        ),
        detailing = actualID-1;
    }

        card.appendChild(link)

        // gerando cabeçalho do card
        const header = document.createElement('div');
        header.classList.add('header');

        // adicionando o texto ao cabeçalho
        header.appendChild(geraSpan(alias));

        // adicionando header ao card
        card.appendChild(header);

        // adicionando legenda do CPU ao card
        card.appendChild(geraSpan('CPU'));

        // adicionando barra do CPU ao card
        card.appendChild(geraBar(cpuT,'cpu'+id));

        // adicionando legenda do Memória ao card
        card.appendChild(geraSpan('MEM'));

        // adicionando barra do Memória ao card        
        card.appendChild(geraBar(mem,'mem'+id));

        return card;
    }

    function geraSpan(string,stringId = null){


        // gera os textos
        const span = document.createElement('span');
        span.textContent = string;

        // dá um id ao span se for passado algum id
        if (stringId != null) {
            span.id = stringId;
        }

        return span;
    }

    function geraBar(value,stringId){
        // garantindo que o valor será um Float
        var usage = parseFloat(value);

        // criando a barra
        const bar = document.createElement('div');
        bar.classList.add('bar');
        
        // criando o texto da barra
        bar.appendChild(geraSpan(value+'%',stringId));
        
        // criando o progresso da barra
        const progress = document.createElement('div');
        progress.classList.add('progress');
        progress.id = stringId + 'Bar';

        // definindo sua %
        progress.style.width = usage + '%';

        // definindo sua cor
        progress.style.backgroundColor = defineProgressColor(usage)

        // adicionando o progresso à barra
        bar.appendChild(progress);

        return bar;
    }

    function updateBar(value,stringId) {
        var usage = parseFloat(value);
        
        const progress = document.getElementById(stringId+'Bar');
        progress.style.width = usage + '%';

        progress.style.backgroundColor = defineProgressColor(usage);

        const span = document.getElementById(stringId);
        span.textContent = value+'%';
    }

    function defineProgressColor(usage) {
        if (usage < 31) {
            return 'greenyellow';
        } else if (usage < 76) {
            return 'yellow';
        } else {
            return 'red';
        }
    }

    window.onclick = function(event) {

        const modal = document.getElementById('modalMain');
        const modalContent = document.getElementById('modalContent');
        const detailing = document.getElementById('detailing');

        if (event.target == modal) {
            detailing.replaceChildren();
            modal.style.display = 'none';
            modalContent.replaceChildren();
        }
    }

    function geraDetailing(id,alias,cpuD,mem) {

        
        // cria o card de detalhamento
        const detailingCard = document.createElement('div');
        detailingCard.classList.add('detailing-card');
        detailingCard.id = 'detailing';
        
        // cria o header do card
        const header = document.createElement('div');
        header.classList.add('header');
        
        // adiciona o nome da máquina ao header
        header.appendChild(geraSpan(alias));
        
        // adicionando o header ao card
        detailingCard.appendChild(header);
        
        // cria parte da CPU
        const cpuHolder = document.createElement('div');
        cpuHolder.classList.add('holder');
        
        cpuHolder.appendChild(geraSpan('CPU'));
        
        // cria uma variável de controle
        var containers = [];
        // divide os dados brutos
        var cpuDetails = cpuD.split(';');
        // variável de cntrole
        var i = 0;
        
        //
        cpuDetails.forEach((core) => {


            const container = document.createElement('div');
            container.classList.add('container');

            container.appendChild(geraSpan('CPU-' + i));

            container.appendChild(geraBar(core,'detailcpu' + i));

            // container.appendChild(geraSpan(core + '%'));

            containers.push(container);
            i++;
        }

    )
    
    //
    containers.forEach((cont) => {
        cpuHolder.appendChild(cont);
    })

    // adicionando o cpuHolder no detailingCard
    detailingCard.appendChild(cpuHolder);

    // gera o memHolder
    const memHolder = document.createElement('div');
    memHolder.classList.add('holder');

    memHolder.appendChild(geraSpan('MEMÓRIA'));
    
    // gera o container da memória
    var container = document.createElement('div');
    container.classList.add('container');
    container.appendChild(geraSpan('MEM'));
    container.appendChild(geraBar(mem,'detailmem'));

    memHolder.appendChild(container);

    detailingCard.appendChild(memHolder);


    const modal = document.getElementById('modalMain');

    var modalContent = document.getElementById('modalContent') ;

    //modalContent.replaceChildren();
    
    modalContent.appendChild(detailingCard);

    modal.style.display = 'block';

    //return id;
    }

    function updateDetailing(cpuD,mem){

        var cpuDetails = cpuD.split(';')

        var i = 0;

        cpuDetails.forEach((usage) => {
            updateBar(usage,'detailcpu'+i);
            i++
        })

        updateBar(mem,'detailmem')

    }

    </script>
</head>

<body>
    
    <div class="header">
        <object type="image/svg+xml" data="assets/img/logobranco.svg"></object>
        <h1>Visualizador de Saúde da máquina </h1>
    </div>
    <!-- Armazena o modal com o card de detalhamento-->
    <div class="modal" id="modalMain">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <!-- Armazena o grid container, que segura todos os cards com as máquinas-->
    <div class="grid-container" id="devices-container"></div>
    

</body>
</html>